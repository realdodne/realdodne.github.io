<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>주소로 장소 표시하기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css" />
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 850px"></div>
    <input type="file" onchange="readExcel()" />
    <button onclick="displayMarkersFromExcel()">주소 표시하기</button>
    <!-- <button onclick="smallfoo()">작게</button> -->
    <div class="check"></div>
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=964184e25668e94f93cf54ddb2e873f0&libraries=services"
    ></script>
    <script>
      let rows;
      //엑셀 읽기 row에 json으로 저장됨
      function readExcel() {
        let input = event.target;
        if (!input.files || input.files.length === 0) {
          alert('엑셀 파일을 선택해주세요.');
          return;
        }
        let reader = new FileReader();
        reader.onload = function () {
          let data = reader.result;
          let workBook = XLSX.read(data, { type: 'binary' });
          workBook.SheetNames.forEach(function (sheetName) {
            rows = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
          });
        };
        reader.readAsBinaryString(input.files[0]);
      }

      var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
          center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
          level: 3, // 지도의 확대 레벨
        };

      // 지도를 생성합니다
      var map = new kakao.maps.Map(mapContainer, mapOption);
      var zoomControl = new kakao.maps.ZoomControl();
      map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
      // 주소-좌표 변환 객체를 생성합니다
      var geocoder = new kakao.maps.services.Geocoder();

      // 지도에 클릭 이벤트를 등록합니다. 지도를 클릭하면 열려있는 툴팁을 닫습니다.
      kakao.maps.event.addListener(map, 'click', function () {
        tooltipOverlay.setMap(null);
        currentTooltipKey = null;
      });

      // 겹친 마커 정보를 보여줄 툴팁 오버레이 (전역 변수)
      var tooltipOverlay = new kakao.maps.CustomOverlay({
        zIndex: 100, // 마커보다 위에 보이도록 설정
        yAnchor: 1, // 좌표가 툴팁의 아래쪽에 위치하도록 설정
      });

      let coordMap = {}; // 좌표별 번호 목록을 저장할 객체
      let currentTooltipKey = null; // 현재 열려있는 툴팁의 키

      // 마커 클릭 시 툴팁을 토글하는 함수
      function toggleTooltip(key) {
        if (currentTooltipKey === key) {
          // 이미 열려있는 툴팁을 클릭하면 닫음
          tooltipOverlay.setMap(null);
          currentTooltipKey = null;
        } else {
          // 다른 마커를 클릭하거나 닫혀있을 때 열음
          if (coordMap[key] && coordMap[key].length > 0) {
            var content = `<div class="tooltip">겹친 번호: ${coordMap[key].join(', ')}</div>`;
            tooltipOverlay.setContent(content);
            var latlng = key.split(',');
            tooltipOverlay.setPosition(new kakao.maps.LatLng(latlng[0], latlng[1]));
            tooltipOverlay.setMap(map);
            currentTooltipKey = key;
          }
        }
      }

      // 주소 수정 함수
      function modifyAddress(index, btn) {
        const currentAddress = rows[index].주소;

        // 브라우저의 클립보드 API를 사용하여 주소를 복사합니다.
        if (navigator.clipboard) {
          navigator.clipboard.writeText(currentAddress).then(
            function () {
              // 복사 성공 시 버튼 텍스트를 잠시 변경하여 피드백 제공
              if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '복사 완료!';
                btn.disabled = true;
                setTimeout(() => {
                  btn.textContent = originalText;
                  btn.disabled = false;
                }, 1500); // 1.5초 후에 원래대로
              }
            },
            function () {
              // 복사 실패 시 (예: 사용자가 권한 거부)
              alert('클립보드 복사에 실패했습니다.');
            }
          );
        } else {
          // 클립보드 API를 지원하지 않는 경우(예: http 또는 file:// 환경)
          alert('자동 복사를 지원하지 않는 환경입니다. 주소를 직접 복사해주세요.');
        }

        new daum.Postcode({
          oncomplete: function (data) {
            rows[index].주소 = data.address;
            let errorDiv = document.getElementById('error-' + index);
            if (errorDiv) {
              errorDiv.innerHTML = `${index + 1}번 : <span style="color: blue;">${rows[index].주소}</span> (수정됨) <button onclick="modifyAddress(${index}, this)">다시 수정</button>`;
            }
            retryGeocode(index);
          },
        }).open();
      }

      // 수정된 주소로 다시 마커를 생성하는 함수
      function retryGeocode(index) {
        // 1. Clean up old marker and its data
        if (markerInfoMap[index]) {
          const oldInfo = markerInfoMap[index];
          const oldKey = oldInfo.key;
          const numberToRemove = rows[index].번호;

          // Remove overlay from map
          oldInfo.overlay.setMap(null);

          // Remove number from coordMap
          if (coordMap[oldKey]) {
            const idx = coordMap[oldKey].indexOf(numberToRemove);
            if (idx > -1) {
              coordMap[oldKey].splice(idx, 1);
            }
          }
        }
        geocoder.addressSearch(rows[index].주소, function (result, status) {
          if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            var key = result[0].y + ',' + result[0].x;

            if (!coordMap[key]) coordMap[key] = [];
            coordMap[key].push(rows[index].번호);

            createMarker(coords, rows[index].번호, key, index);

            // 지도 중심을 수정된 위치로 이동
            map.setCenter(coords);
          } else {
            alert('수정한 주소도 위치를 찾을 수 없습니다.');
          }
        });
      }

      // 주소 목록을 지도에 표시하는 함수
      let markerInfoMap = {}; // { index: { overlay: CustomOverlay, key: 'lat,lng' } }
      function displayMarkersFromExcel() {
        if (!rows) {
          alert('먼저 엑셀 파일을 업로드해주세요.');
          return;
        }

        // 모든 마커를 포함할 수 있도록 지도의 범위를 재설정하기 위한 객체
        var bounds = new kakao.maps.LatLngBounds();
        // 기존 오버레이들을 초기화합니다.
        Object.values(markerInfoMap).forEach(function (info) {
          info.overlay.setMap(null);
        });
        markerInfoMap = {};
        document.querySelector('.check').innerHTML = ''; // 오류 메시지 초기화
        coordMap = {}; // 좌표별 데이터 초기화
        let processedCount = 0; // 비동기 작업 카운터

        for (let i = 0; i < rows.length; i++) {
          // API 요청 제한을 피하기 위해 약간의 지연을 줍니다.
          setTimeout(function () {
            geocoder.addressSearch(rows[i].주소, function (result, status) {
              processedCount++; // 처리된 주소 개수 증가

              // 정상적으로 검색이 완료됐으면
              if (status === kakao.maps.services.Status.OK) {
                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                // 좌표를 키(Key)로 사용하여 번호를 저장합니다.
                var key = result[0].y + ',' + result[0].x;
                if (!coordMap[key]) coordMap[key] = [];
                coordMap[key].push(rows[i].번호);

                createMarker(coords, rows[i].번호, key, i);
                // LatLngBounds 객체에 좌표를 추가합니다
                bounds.extend(coords);
              } else if (status !== kakao.maps.services.Status.OK) {
                // 동일한 에러 메시지가 중복으로 표시되는 것을 방지합니다.
                if (!document.getElementById(`error-${i}`)) {
                  const errorHtml = `<div id="error-${i}">${i + 1}번 : <span style="color: red;">${rows[i].주소}</span> 가 정확하지 않습니다. <button onclick="modifyAddress(${i}, this)">주소 수정</button></div>`;
                  document.querySelector('.check').insertAdjacentHTML('beforeend', errorHtml);
                  console.log(i + 1 + '번 : ' + rows[i].주소 + ' 정확하지 않아요.');
                }
              }

              // 모든 주소에 대한 처리가 끝났을 때
              if (processedCount === rows.length) {
                // 마커가 하나 이상 있을 경우에만 지도 범위를 재설정합니다.
                if (Object.keys(markerInfoMap).length > 0) {
                  map.setBounds(bounds);
                }
              }
            });
          }, i * 100); // 0.1초 간격으로 API 요청
        }
      }

      // 마커 생성 로직 분리
      function createMarker(coords, number, key, index) {
        // DOM 요소를 직접 생성하여 이벤트를 등록합니다.
        var content = document.createElement('div');
        content.className = 'wrap';
        content.innerHTML =
          '    <div class="info">' +
          `     <div class="info-content">${number}</div>` +
          '    </div>';

        // 이벤트 리스너 등록
        content.addEventListener('click', function (e) {
          // 마커를 클릭했을 때 지도의 클릭 이벤트가 발생하지 않도록 중단시킵니다.
          e.stopPropagation ? e.stopPropagation() : (e.cancelBubble = true);
          toggleTooltip(key);
        });

        // 마커 위에 커스텀오버레이를 표시합니다
        var overlay = new kakao.maps.CustomOverlay({
          content: content,
          map: map,
          position: coords,
        });
        markerInfoMap[index] = { overlay: overlay, key: key };
      }

      function smallfoo() {
        let find =
          document.querySelector('#map').children[0].children[0].lastChild
            .children;
        let findlength = find.length;
        // find.style.background = 'rgb(0,0,0,0)';
        console.log(findlength);
        for (let i = 0; i < findlength; i++) {
          find[i].style.background = 'rgb(0,0,0,0)';
          find[i].style.width = '0px';
          find[i].style.height = '0px';
        }
      }
    </script>
  </body>
</html>
